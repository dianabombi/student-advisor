"""
Educational Compliance Module for Student Advisor Platform

Provides utilities to ensure AI responses are educational and informative.
Includes multilingual disclaimers and system prompts.

Author: Student Advisor Team
Date: 2025-12-19
"""

from typing import Dict, Optional
import re


class UPLCompliance:
    """
    Centralized educational compliance utilities for Student Advisor AI assistant.
    
    Ensures all AI responses:
    - Include proper disclaimers
    - Provide legal information (not advice)
    - Follow safe zone guidelines
    - Comply with regulations across all 10 jurisdictions
    """
    
    # Multilingual disclaimers for all 10 supported languages
    DISCLAIMERS = {
        'sk': "âš ï¸ Student Advisor je vzdelÃ¡vacia platforma a neposkytuje profesionÃ¡lne poradenstvo. TÃ¡to informÃ¡cia je urÄenÃ¡ len na vÅ¡eobecnÃ© vzdelÃ¡vacie ÃºÄely.",
        
        'en': "âš ï¸ Student Advisor is an educational platform and does not provide professional advice. This information is intended for general educational purposes only.",
        
        'uk': "âš ï¸ Student Advisor Ñ” Ð¾ÑÐ²Ñ–Ñ‚Ð½ÑŒÐ¾ÑŽ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð¾ÑŽ Ñ– Ð½Ðµ Ð½Ð°Ð´Ð°Ñ” Ð¿Ñ€Ð¾Ñ„ÐµÑÑ–Ð¹Ð½Ð¸Ñ… ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ñ–Ð¹. Ð¦Ñ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ Ð¿Ñ€Ð¸Ð·Ð½Ð°Ñ‡ÐµÐ½Ð° Ð»Ð¸ÑˆÐµ Ð´Ð»Ñ Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ð¸Ñ… Ð¾ÑÐ²Ñ–Ñ‚Ð½Ñ–Ñ… Ñ†Ñ–Ð»ÐµÐ¹.",
        
        'ru': "âš ï¸ Student Advisor ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð¾Ð¹ Ð¸ Ð½Ðµ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¹. Ð­Ñ‚Ð° Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð¾Ð±Ñ‰Ð¸Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ñ†ÐµÐ»ÐµÐ¹.",
        
        'de': "âš ï¸ Student Advisor ist eine Bildungsplattform und bietet keine professionelle Beratung an. Diese Informationen dienen nur allgemeinen Bildungszwecken.",
        
        'it': "âš ï¸ Student Advisor Ã¨ una piattaforma educativa e non fornisce consulenza professionale. Queste informazioni sono destinate solo a scopi educativi generali.",
        
        'fr': "âš ï¸ Student Advisor est une plateforme Ã©ducative et ne fournit pas de conseils professionnels. Ces informations sont destinÃ©es uniquement Ã  des fins Ã©ducatives gÃ©nÃ©rales.",
        
        'es': "âš ï¸ Student Advisor es una plataforma educativa y no proporciona asesoramiento profesional. Esta informaciÃ³n estÃ¡ destinada solo para fines educativos generales.",
        
        'pl': "âš ï¸ Student Advisor jest platformÄ… edukacyjnÄ… i nie Å›wiadczy profesjonalnych usÅ‚ug doradczych. Te informacje sÄ… przeznaczone wyÅ‚Ä…cznie do ogÃ³lnych celÃ³w edukacyjnych.",
        
        'cs': "âš ï¸ Student Advisor je vzdÄ›lÃ¡vacÃ­ platforma a neposkytuje profesionÃ¡lnÃ­ poradenstvÃ­. Tyto informace jsou urÄeny pouze pro vÅ¡eobecnÃ© vzdÄ›lÃ¡vacÃ­ ÃºÄely."
    }
    
    # Document generation disclaimer
    DOCUMENT_DISCLAIMERS = {
        'sk': """
âš ï¸ ZASTEREÐ–Ð•ÐÐÐ¯:
Tento dokument bol vygenerovanÃ½ AI a nebol preverenÃ½ prÃ¡vnikom.
PouÅ¾ite ho ako Å¡ablÃ³nu. OdporÃºÄame overenie licencovanÃ½m advokÃ¡tom pred pouÅ¾itÃ­m.
""",
        'en': """
âš ï¸ DISCLAIMER:
This document was generated by AI and has not been reviewed by a lawyer.
Use it as a template. We recommend verification by a licensed attorney before use.
""",
        'uk': """
âš ï¸ Ð—ÐÐ¡Ð¢Ð•Ð Ð•Ð–Ð•ÐÐÐ¯:
Ð¦ÐµÐ¹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð·Ð³ÐµÐ½ÐµÑ€Ð¾Ð²Ð°Ð½Ð¾ AI Ñ– Ð½Ðµ Ð¿ÐµÑ€ÐµÐ³Ð»ÑÐ½ÑƒÑ‚Ð¸Ð¹ ÑŽÑ€Ð¸ÑÑ‚Ð¾Ð¼.
Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹Ñ‚Ðµ Ð¹Ð¾Ð³Ð¾ ÑÐº ÑˆÐ°Ð±Ð»Ð¾Ð½. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÑ”Ð¼Ð¾ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÑƒ Ð»Ñ–Ñ†ÐµÐ½Ð·Ð¾Ð²Ð°Ð½Ð¸Ð¼ Ð°Ð´Ð²Ð¾ÐºÐ°Ñ‚Ð¾Ð¼ Ð¿ÐµÑ€ÐµÐ´ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð½Ð½ÑÐ¼.
""",
        'ru': """
âš ï¸ ÐŸÐ Ð•Ð”Ð£ÐŸÐ Ð•Ð–Ð”Ð•ÐÐ˜Ð•:
Ð­Ñ‚Ð¾Ñ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð±Ñ‹Ð» ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ AI Ð¸ Ð½Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½ ÑŽÑ€Ð¸ÑÑ‚Ð¾Ð¼.
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐµÐ³Ð¾ ÐºÐ°Ðº ÑˆÐ°Ð±Ð»Ð¾Ð½. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼ Ð°Ð´Ð²Ð¾ÐºÐ°Ñ‚Ð¾Ð¼ Ð¿ÐµÑ€ÐµÐ´ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼.
""",
        'de': """
âš ï¸ HAFTUNGSAUSSCHLUSS:
Dieses Dokument wurde von AI generiert und nicht von einem Anwalt Ã¼berprÃ¼ft.
Verwenden Sie es als Vorlage. Wir empfehlen eine ÃœberprÃ¼fung durch einen zugelassenen Rechtsanwalt vor der Verwendung.
""",
        'it': """
âš ï¸ DISCLAIMER:
Questo documento Ã¨ stato generato da AI e non Ã¨ stato revisionato da un avvocato.
Usalo come modello. Raccomandiamo la verifica da parte di un avvocato autorizzato prima dell'uso.
""",
        'fr': """
âš ï¸ AVERTISSEMENT:
Ce document a Ã©tÃ© gÃ©nÃ©rÃ© par AI et n'a pas Ã©tÃ© vÃ©rifiÃ© par un avocat.
Utilisez-le comme modÃ¨le. Nous recommandons une vÃ©rification par un avocat agrÃ©Ã© avant utilisation.
""",
        'es': """
âš ï¸ DESCARGO DE RESPONSABILIDAD:
Este documento fue generado por AI y no ha sido revisado por un abogado.
Ãšselo como plantilla. Recomendamos verificaciÃ³n por un abogado licenciado antes de usar.
""",
        'pl': """
âš ï¸ ZASTRZEÅ»ENIE:
Ten dokument zostaÅ‚ wygenerowany przez AI i nie zostaÅ‚ sprawdzony przez prawnika.
UÅ¼yj go jako szablonu. Zalecamy weryfikacjÄ™ przez licencjonowanego adwokata przed uÅ¼yciem.
""",
        'cs': """
âš ï¸ UPOZORNÄšNÃ:
Tento dokument byl vygenerovÃ¡n AI a nebyl zkontrolovÃ¡n prÃ¡vnÃ­kem.
PouÅ¾ijte jej jako Å¡ablonu. DoporuÄujeme ovÄ›Å™enÃ­ licencovanÃ½m advokÃ¡tem pÅ™ed pouÅ¾itÃ­m.
"""
    }
    
    @staticmethod
    def get_disclaimer(language: str = 'sk') -> str:
        """
        Get UPL disclaimer in specified language.
        
        Args:
            language: Language code (sk, en, uk, ru, de, it, fr, es, pl, cs)
            
        Returns:
            Disclaimer text in specified language
        """
        return UPLCompliance.DISCLAIMERS.get(language, UPLCompliance.DISCLAIMERS['sk'])
    
    @staticmethod
    def get_document_disclaimer(language: str = 'sk') -> str:
        """
        Get document generation disclaimer in specified language.
        
        Args:
            language: Language code
            
        Returns:
            Document disclaimer text
        """
        return UPLCompliance.DOCUMENT_DISCLAIMERS.get(language, UPLCompliance.DOCUMENT_DISCLAIMERS['sk'])
    
    @staticmethod
    def get_system_prompt(language: str = 'sk') -> str:
        """
        Get UPL-compliant system prompt for AI assistant.
        
        Args:
            language: Language code for response language
            
        Returns:
            UPL-compliant system prompt
        """
        # Multilingual system prompts
        prompts = {
            'sk': """Si asistent pre prÃ¡vne informÃ¡cie (NIE prÃ¡vnik) Å¡pecializujÃºci sa na slovenskÃ© prÃ¡vo.

ðŸ”µ ÄŒO MÃ”Å½EÅ  ROBIÅ¤ (Safe Zone):
âœ… VysvetÄ¾ovaÅ¥ vÅ¡eobecnÃ© prÃ¡vne princÃ­py
   PrÃ­klad: "Na Slovensku ObÄiansky zÃ¡konnÃ­k upravuje zmluvy v Â§Â§ 34-51..."
   
âœ… UkazovaÅ¥ relevantnÃ© ÄlÃ¡nky zÃ¡konov
   PrÃ­klad: "PodÄ¾a Â§ 97 ZÃ¡konnÃ­ka prÃ¡ce, prÃ¡ca cez vÃ­kend sa kompenzuje..."
   
âœ… PoskytovaÅ¥ Å¡ablÃ³ny dokumentov s disclaimerom
   PrÃ­klad: "Tu je vzorovÃ¡ sÅ¥aÅ¾nosÅ¥. âš ï¸ OdporÃºÄam overenie prÃ¡vnikom."
   
âœ… VysvetÄ¾ovaÅ¥ prÃ¡vne procedÃºry
   PrÃ­klad: "Proces podania sÅ¥aÅ¾nosti: 1) NapÃ­saÅ¥ sÅ¥aÅ¾nosÅ¥, 2) PodaÅ¥ na sÃºd..."
   
âœ… AnalyzovaÅ¥ dokumenty s disclaimerom
   PrÃ­klad: "V tejto zmluve vidÃ­m tieto rizikÃ¡... âš ï¸ Toto je vÅ¡eobecnÃ¡ analÃ½za, nie prÃ¡vna rada."

âŒ ÄŒO NESMIEÅ  ROBIÅ¤ (Red Zone):
âŒ KonkrÃ©tne prÃ¡vne rady pre prÃ­pad pouÅ¾Ã­vateÄ¾a
   ZLYHANIE: "VY by ste mali podaÅ¥ Å¾alobu"
   SPRÃVNE: "VÅ¡eobecne, pri poruÅ¡enÃ­ zmluvy moÅ¾no podaÅ¥ Å¾alobu. OdporÃºÄam konzultÃ¡ciu s advokÃ¡tom."

âŒ InterpretÃ¡cia zÃ¡kona pre konkrÃ©tnu situÃ¡ciu
   ZLYHANIE: "Tento zÃ¡kon znamenÃ¡, Å¾e VY mÃ¡te nÃ¡rok na â‚¬500"
   SPRÃVNE: "PodÄ¾a tohto zÃ¡kona mÃ´Å¾e vzniknÃºÅ¥ nÃ¡rok na kompenzÃ¡ciu. Pre posÃºdenie VÃÅ HO prÃ­padu kontaktujte advokÃ¡ta."

âŒ Garancie vÃ½sledkov
   ZLYHANIE: "UrÄite vyhrÃ¡te sÃºd"
   SPRÃVNE: "VÃ½sledok zÃ¡visÃ­ od mnohÃ½ch faktorov. AdvokÃ¡t posÃºdi vaÅ¡e Å¡ance."

âŒ Zastupovanie
   ZLYHANIE: "NapÃ­Å¡em pozov za vÃ¡s"
   SPRÃVNE: "MÃ´Å¾em ukÃ¡zaÅ¥ vzor pozvu. OdporÃºÄam, aby ho pripravil advokÃ¡t."

âš ï¸ POVINNÃ‰ PRAVIDLÃ:
1. VÅ½DY zaÄni odpoveÄ disclaimerom: "ðŸ¤– Student Advisor je vzdelÃ¡vacia platforma..."
2. NIKDY nepouÅ¾Ã­vaj "VY by ste mali", "VÃÅ  prÃ­pad", "urÄite vyhrÃ¡te"
3. VÅ½DY odporÃºÄaj konzultÃ¡ciu s advokÃ¡tom pre konkrÃ©tne situÃ¡cie
4. PouÅ¾Ã­vaj "vÅ¡eobecne", "zvyÄajne", "mÃ´Å¾e", nie "musÃ­te", "urÄite"

Odpovedaj v slovenÄine, jasne a profesionÃ¡lne.""",

            'en': """You are a legal information assistant (NOT a lawyer) specializing in law.

ðŸ”µ WHAT YOU CAN DO (Safe Zone):
âœ… Explain general legal principles
âœ… Show relevant law articles
âœ… Provide document templates with disclaimers
âœ… Explain legal procedures
âœ… Analyze documents with "general analysis" disclaimer

âŒ WHAT YOU CANNOT DO (Red Zone):
âŒ Specific legal advice for user's case
âŒ Interpret law for specific situation
âŒ Guarantee case outcomes
âŒ Represent users
âŒ Use phrases like "you MUST", "you WILL WIN"

âš ï¸ MANDATORY RULES:
1. ALWAYS start response with: "ðŸ¤– Student Advisor is an educational platform..."
2. NEVER use "YOU should", "YOUR case will", "definitely win"
3. ALWAYS recommend consulting licensed attorney for specific situations
4. Use "generally", "typically", "may", not "must", "definitely"

Respond in English, clearly and professionally."""
        }
        
        # Default to Slovak if language not found
        return prompts.get(language, prompts['sk'])
    
    @staticmethod
    def inject_disclaimer(response: str, language: str = 'sk') -> str:
        """
        Inject disclaimer at the beginning of AI response.
        
        Args:
            response: Original AI response
            language: Language code
            
        Returns:
            Response with disclaimer prepended
        """
        disclaimer = UPLCompliance.get_disclaimer(language)
        
        # Check if disclaimer already exists
        if disclaimer in response or "âš ï¸ Student Advisor" in response[:200]:
            return response
        
        return f"{disclaimer}\n\n{response}"
    
    @staticmethod
    def validate_response_compliance(response: str, language: str = 'sk') -> Dict[str, any]:
        """
        Validate if AI response complies with UPL regulations.
        
        Args:
            response: AI response to validate
            language: Language code
            
        Returns:
            Dictionary with validation results:
            - is_compliant: bool
            - violations: list of detected violations
            - warnings: list of potential issues
        """
        violations = []
        warnings = []
        
        # Check for forbidden phrases (Slovak)
        if language == 'sk':
            forbidden_patterns = [
                (r'\bvy by ste mali\b', "Uses 'vy by ste mali' (you should)"),
                (r'\bvÃ½Å¡ prÃ­pad\b', "Uses 'vÃ¡Å¡ prÃ­pad' (your case)"),
                (r'\burÄite vyhrÃ¡te\b', "Guarantees outcome 'urÄite vyhrÃ¡te'"),
                (r'\bnapÃ­Å¡em (pozov|Å¾alobu) za vÃ¡s\b', "Offers to write legal documents"),
                (r'\bmÃ¡te nÃ¡rok na\b', "States specific entitlement 'mÃ¡te nÃ¡rok na'"),
            ]
            
            for pattern, violation in forbidden_patterns:
                if re.search(pattern, response, re.IGNORECASE):
                    violations.append(violation)
        
        # Check for disclaimer presence
        if "âš ï¸" not in response[:300] and "Student Advisor" not in response[:300]:
            warnings.append("Disclaimer may be missing or not at the beginning")
        
        # Check for recommendation to consult lawyer
        lawyer_keywords = {
            'sk': ['advokÃ¡t', 'prÃ¡vnik', 'konzultÃ¡cia'],
            'en': ['attorney', 'lawyer', 'consult'],
            'uk': ['Ð°Ð´Ð²Ð¾ÐºÐ°Ñ‚', 'ÑŽÑ€Ð¸ÑÑ‚', 'ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ñ–Ñ'],
            'ru': ['Ð°Ð´Ð²Ð¾ÐºÐ°Ñ‚', 'ÑŽÑ€Ð¸ÑÑ‚', 'ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ'],
        }
        
        keywords = lawyer_keywords.get(language, lawyer_keywords['sk'])
        has_lawyer_recommendation = any(keyword in response.lower() for keyword in keywords)
        
        if not has_lawyer_recommendation and len(response) > 200:
            warnings.append("No recommendation to consult a lawyer")
        
        return {
            'is_compliant': len(violations) == 0,
            'violations': violations,
            'warnings': warnings
        }
    
    @staticmethod
    def detect_language(text: str) -> str:
        """
        Detect language from text (simple heuristic).
        
        Args:
            text: Text to analyze
            
        Returns:
            Detected language code
        """
        # Simple keyword-based detection
        language_indicators = {
            'sk': ['slovensko', 'zÃ¡kon', 'prÃ¡vny', 'zmluva', 'sÃºd'],
            'en': ['law', 'legal', 'contract', 'court', 'attorney'],
            'uk': ['ÑƒÐºÑ€Ð°Ñ—Ð½Ð°', 'Ð·Ð°ÐºÐ¾Ð½', 'ÑŽÑ€Ð¸Ð´Ð¸Ñ‡Ð½Ð¸Ð¹', 'Ð´Ð¾Ð³Ð¾Ð²Ñ–Ñ€', 'ÑÑƒÐ´'],
            'ru': ['Ñ€Ð¾ÑÑÐ¸Ñ', 'Ð·Ð°ÐºÐ¾Ð½', 'ÑŽÑ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹', 'Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€', 'ÑÑƒÐ´'],
            'de': ['deutschland', 'gesetz', 'rechtlich', 'vertrag', 'gericht'],
            'pl': ['polska', 'prawo', 'prawny', 'umowa', 'sÄ…d'],
            'cs': ['Äesko', 'zÃ¡kon', 'prÃ¡vnÃ­', 'smlouva', 'soud'],
        }
        
        text_lower = text.lower()
        
        for lang, keywords in language_indicators.items():
            if any(keyword in text_lower for keyword in keywords):
                return lang
        
        # Default to Slovak
        return 'sk'


# Convenience functions for easy import
def get_disclaimer(language: str = 'sk') -> str:
    """Get UPL disclaimer in specified language."""
    return UPLCompliance.get_disclaimer(language)


def get_system_prompt(language: str = 'sk') -> str:
    """Get UPL-compliant system prompt."""
    return UPLCompliance.get_system_prompt(language)


def inject_disclaimer(response: str, language: str = 'sk') -> str:
    """Inject disclaimer into AI response."""
    return UPLCompliance.inject_disclaimer(response, language)


def validate_compliance(response: str, language: str = 'sk') -> Dict:
    """Validate AI response compliance."""
    return UPLCompliance.validate_response_compliance(response, language)
