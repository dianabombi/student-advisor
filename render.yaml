# Render.com Blueprint - Student Advisor Platform
# Deploy: Connect your GitHub repo at https://dashboard.render.com/blueprints

databases:
  - name: student-db
    plan: free
    databaseName: student_db
    user: student_user
    postgresMajorVersion: "16"

services:
  # FastAPI Backend
  - type: web
    name: student-backend
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    plan: free
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: student-db
          property: connectionURI
      - key: OPENAI_API_KEY
        sync: false # You'll set this manually in Render dashboard
      - key: SECRET_KEY
        generateValue: true
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: "30"
      - key: ENVIRONMENT
        value: production
      - key: REDIS_URL
        fromService:
          name: student-redis
          type: redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          name: student-redis
          type: redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          name: student-redis
          type: redis
          property: connectionString
      - key: MINIO_ENDPOINT
        value: "" # Optional: set if using external S3/MinIO
      - key: MINIO_ACCESS_KEY
        value: ""
      - key: MINIO_SECRET_KEY
        value: ""
    healthCheckPath: /health

  # Celery Worker (background tasks)
  - type: worker
    name: student-celery-worker
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    plan: free
    dockerCommand: "celery -A celery_app worker --loglevel=info --concurrency=2"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: student-db
          property: connectionURI
      - key: OPENAI_API_KEY
        sync: false
      - key: SECRET_KEY
        generateValue: true
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: REDIS_URL
        fromService:
          name: student-redis
          type: redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          name: student-redis
          type: redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          name: student-redis
          type: redis
          property: connectionString

  # Redis
  - type: redis
    name: student-redis
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []
